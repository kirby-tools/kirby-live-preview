(function(){"use strict";const i=window.Vue;function m(){return window.panel}function J(){return m().api}const U=()=>window.panel.plugins.viewButtons!==void 0;function pe(){return U()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):m().app.$store}function de(){const n=m(),t=pe(),o=U();if(o&&!("diff"in n.content))throw new Error("This plugin requires Kirby 5.0.0-rc.1 or higher. Please update your Kirby installation.");const e=y(o?()=>n.content.version("changes"):()=>t.getters["content/values"]()),r=y(o?()=>n.content.diff():()=>t.getters["content/changes"]()),s=y(o?()=>n.content.hasDiff():()=>t.getters["content/hasChanges"]()),c=o?n.content:new Proxy({},{get(){return()=>{}}});return{content:c,currentContent:e,contentChanges:r,hasChanges:s,update:async(u,f=!0)=>{if(!o&&u)for(const[g,C]of Object.entries(u))t.dispatch("content/update",[g,C]);const v=c.merge(u);f&&await c.save(v)}}}function fe(){const n=U();function t(e){let r=!1;return new Promise(s=>{const c=m();c.dialog.open({component:"k-text-dialog",props:{text:e},on:{submit:()=>{r=!0,c.dialog.close()},...n?{closed:()=>{s(r)}}:{close:()=>{setTimeout(()=>s(r),25)}}}})})}function o(e){let r;const{onSubmit:s,...c}=e;return new Promise(h=>{const u=m();u.dialog.open({component:"k-form-dialog",props:c,on:{submit:async f=>{const v=f;if(s)try{const g=await s(v);if(g===!1)return;r=g}catch{return}else r=v;u.dialog.close()},...n?{closed:()=>{h(r)}}:{close:()=>{setTimeout(()=>h(r),0)}}}})})}return{openTextDialog:t,openFieldsDialog:o}}function ve(){const n=m();function t(o){return!o||typeof o=="string"?o:o[n.translation.code]??Object.values(o)[0]}return{t}}function he(){const n=J();return{load:({parent:o,name:e})=>n.get(`${o}/sections/${e}`)}}const y=i.computed;i.customRef,i.defineAsyncComponent,i.defineComponent,i.effectScope,i.getCurrentInstance,i.getCurrentScope,i.h,i.inject,i.isProxy,i.isReactive,i.isReadonly,i.isRef,i.isShallow,i.markRaw;const H=i.nextTick;i.onActivated,i.onBeforeMount;const X=i.onBeforeUnmount;i.onBeforeUpdate,i.onDeactivated,i.onErrorCaptured;const ge=i.onMounted;i.onRenderTracked,i.onRenderTriggered,i.onScopeDispose,i.onServerPrefetch,i.onUnmounted,i.onUpdated,i.provide,i.proxyRefs,i.reactive,i.readonly;const l=i.ref;i.shallowReactive,i.shallowReadonly,i.shallowRef,i.toRaw,i.toRef,i.toRefs,i.triggerRef;const Y=i.unref;i.useAttrs,i.useCssModule,i.useCssVars,i.useListeners,i.useSlots;const Q=i.watch;i.watchEffect,i.watchPostEffect,i.watchSyncEffect;const z="The activation buttons appear to be hidden. Please purchase a license.",W={de:{activate:"Aktivieren",buy:"Lizenz kaufen",upgrade:"Upgrade","notification.success":"Plugin aktiviert!"},en:{activate:"Activate",buy:"Buy a license",upgrade:"Upgrade","notification.success":"Plugin activated!"},es:{activate:"Activar",buy:"Comprar licencia",upgrade:"Actualizar","notification.success":"¡Plugin activado!"},fr:{activate:"Activer",buy:"Acheter une licence",upgrade:"Upgrade","notification.success":"Plugin activé !"},it:{activate:"Attiva",buy:"Acquista licenza",upgrade:"Aggiorna","notification.success":"Plugin attivato!"},nl:{activate:"Activeren",buy:"Koop een licentie",upgrade:"Upgrade","notification.success":"Plugin geactiveerd!"}},me=["localhost","127.0.0.1","[::1]"],be=["localhost","local","test","ddev.site"];function we(n,t,o){return n.replace(/\{(\w+)\}/g,(e,r)=>t[r]||r)}function Z(n,t){var r;const o=window.panel.translation.code,e=((r=W==null?void 0:W[o])==null?void 0:r[n])??n;return t?we(e,t):e}function ye(){const{hostname:n}=window.location,t=me.includes(n),o=be.some(e=>n.endsWith(`.${e}`));return t||o}function _e(n){const t=m(),{openFieldsDialog:o}=fe();return{isLocalhost:ye(),assertActivationIntegrity:({component:c,licenseStatus:h})=>{var g;if(Y(h)==="active")return;const u=(g=Y(c))==null?void 0:g.$el;if(!u){t.notification.error(z);return}const f=window.getComputedStyle(u);if(f.display==="none"||f.visibility==="hidden"||f.opacity==="0"||f.clipPath==="inset(100%)"||f.transform.includes("scale(0")){t.notification.error(z);return}const v=u.getBoundingClientRect();(v.width===0||v.height===0||v.right<0||v.bottom<0||v.left>window.innerWidth||v.top>window.innerHeight)&&t.notification.error(z)},openLicenseModal:async()=>{let c=!1;await o({fields:{info:{type:"info",text:t.t("kirby-tools.license.activate.info")},email:{label:t.t("kirby-tools.license.activate.email"),type:"email",required:!0},orderId:{label:t.t("kirby-tools.license.activate.orderId"),type:"text",required:!0,help:t.t("kirby-tools.license.activate.orderId.help")}},submitButton:{icon:"check",theme:"love",text:t.t("kirby-tools.license.activate.submit")},onSubmit:async h=>c?!1:(c=!0,await ke(h,n)?(t.notification.success(Z("notification.success")),await new Promise(u=>setTimeout(u,750)),window.location.reload(),new Promise(()=>{})):(c=!1,!1))})}}}async function ke(n,t){var s;const o=m(),{email:e,orderId:r}=n;if(!e||!r)return!1;try{if(((s=await o.api.post(`${t.apiNamespace}/activate`,{email:e,orderId:Number(r)}))==null?void 0:s.status)!=="ok")throw new Error("Failed to activate license key");return!0}catch(c){return o.notification.error(c.message),!1}}const Se=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(n){const t=n,{openLicenseModal:o,assertActivationIntegrity:e}=_e({label:t.label,apiNamespace:t.apiNamespace}),r=l(t.licenseStatus),s=l();ge(()=>{e({component:s,licenseStatus:t.licenseStatus})});async function c(){await o()}return{__sfc:!0,props:t,openLicenseModal:o,assertActivationIntegrity:e,currentLicenseStatus:r,licenseButtonGroup:s,handleActivation:c,t:Z}}});function ee(n,t,o,e,r,s,c,h){var u=typeof n=="function"?n.options:n;return t&&(u.render=t,u.staticRenderFns=o,u._compiled=!0),s&&(u._scopeId="data-v-"+s),{exports:n,options:u}}var Le=function(){var t=this,o=t._self._c,e=t._self._setupProxy;return e.currentLicenseStatus!=="active"?o("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[o("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":t.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),o("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(r){return e.handleActivation()}}})],1):t._e()},Pe=[],Re=ee(Se,Le,Pe,!1,null,null);const Ce=Re.exports,Ie={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number};function Te(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var F,te;function xe(){if(te)return F;te=1;function n(t,o){if(typeof t!="function")throw new TypeError(`Expected the first argument to be a \`function\`, got \`${typeof t}\`.`);let e,r=0;return function(...c){clearTimeout(e);const h=Date.now(),u=h-r,f=o-u;f<=0?(r=h,t.apply(this,c)):e=setTimeout(()=>{r=Date.now(),t.apply(this,c)},f)}}return F=n,F}var Ue=xe();const Ee=Te(Ue),Ae=/^\.?\//;function $e(n="",t){return n.endsWith("/")?n:n+"/"}function Oe(n=""){return n.startsWith("/")}function ne(n=""){return Oe(n)?n:"/"+n}function Be(n){return n&&n!=="/"}function De(n,...t){let o=n||"";for(const e of t.filter(r=>Be(r)))if(o){const r=e.replace(Ae,"");o=$e(o)+r}else o=e;return o}function Ne(){const t=m().languages.map(e=>e.code);return{locales:t,getNonLocalizedPath:e=>{const s=(e instanceof URL?e:new URL(e)).pathname.split("/").filter(Boolean);return t.includes(s[0])&&s.shift(),ne(s.join("/"))}}}const je="__live-preview__/context";let E,R;function He(){return E?Promise.resolve(E):R||(R=window.panel.api.get(je,void 0,void 0,!0).then(n=>(E=n,R=void 0,E)),R)}const oe={...Ie},ze=Object.assign({inheritAttrs:!1},{__name:"LivePreview",props:oe,setup(n){const t=n,o=U(),e=m(),r=J(),{t:s}=ve(),{getNonLocalizedPath:c}=Ne(),h={mobile:390,tablet:768,desktop:1440},u=l(),f=l(),v=l(),g=l(),C=l(),A=l(),ie=l(),$=l(!1),O=l(!1),q=l(!1),_=l(),re=l(),S=l(),M=l(!1),ae=l({}),se=l(),B=l(),I=l(),ce=l();let b,D;const N=new AbortController,{contentChanges:T}=de();Q(T,a=>{b&&v.value!==!1&&A.value==="interval"&&JSON.stringify(a)!==D&&b(a)}),Q(()=>e.language.code,()=>{k()});const K=l(!0),j=l(32),V=l(65),Ke=y(()=>`calc(100dvh - ${K.value?`calc(${j.value}px + 5.75rem)`:"2vh"} - ${V.value}px - 2.75rem`);(async()=>{const{load:a}=he(),[w,p]=await Promise.all([He(),a({parent:t.parent,name:t.name})]);u.value=s(p.label)||e.t("johannschopplich.preview.label"),f.value=p.pageId,v.value=p.updateInterval,g.value=p.interactable,C.value=p.aspectRatio||void 0,A.value=p.updateStrategy,ie.value=p.help,se.value=w.licenseStatus,b=Ee(le,v.value||500),k(),await H();const d=document.querySelector(".k-topbar"),x=document.querySelector(".k-header");if(!C.value&&d&&x){j.value=d.offsetHeight,V.value=x.offsetHeight;const L=new IntersectionObserver(([P])=>{K.value=P.isIntersecting,P.isIntersecting&&(j.value=P.target.offsetHeight),G()},{threshold:[0],rootMargin:"64px 0px 0px 0px"});L.observe(d),X(L.disconnect)}window.addEventListener("message",ue,{signal:N.signal}),e.events.on("page.changeTitle",k),e.events.on("file.sort",k),A.value==="blur"&&document.body.addEventListener("blur",()=>{JSON.stringify(T.value)!==D&&(b==null||b(T.value))},{capture:!0,signal:N.signal})})(),X(()=>{N.abort(),e.events.off("page.changeTitle",k),e.events.off("file.sort",k),_.value&&URL.revokeObjectURL(_.value)});function k(a){b==null||b(T.value,a)}function Ve(){const a=new URL(_.value);window.open(a,"_blank")}function Ge(a){S.value=a===S.value?void 0:a,G()}async function G(){if(await H(),!B.value||!S.value||!(S.value in h)){M.value=!1;return}const a=h[S.value],w=B.value.clientWidth,p=B.value.clientHeight,d=w/a;M.value=a<w,ae.value={width:`${a}px`,height:d<1?`${p/d}px`:"100%",transform:d<1?`scale(${d})`:"none",transformOrigin:"top center",position:"absolute",top:0,left:"50%",marginLeft:`${-a/2}px`}}async function le(a,{persistScrollPosition:w=!0}={}){var d,x;if($.value)return;$.value=!0;let p=0;I.value&&(p=I.value.contentWindow.scrollY,(x=(d=ce.value)==null?void 0:d.contentWindow)==null||x.scrollTo(0,p)),O.value=!0;try{const{data:L}=await r.post("__live-preview__/render",{pageId:f.value,content:a,interactable:g.value,model:e.view.path==="site"?"site":"page"}),P=_.value,Xe=new Blob([L],{type:"text/html"});_.value=URL.createObjectURL(Xe),await H(),await new Promise(Ye=>{I.value.addEventListener("load",()=>{p&&w&&I.value.contentWindow.scrollTo(0,p),Ye()},{once:!0})}),O.value=!1,q.value=!1,re.value=_.value,D=JSON.stringify(a),P&&URL.revokeObjectURL(P)}catch(L){console.error(L),q.value=!0,O.value=!1}finally{$.value=!1}}async function ue({data:a}){if(a.type==="save"){e.events.emit(`${e.context}.save`);return}if(a.type==="link"){const w=new URL(a.href);if(w.origin!==window.location.origin){window.open(a.href,"_blank");return}if(["assets","media"].some(d=>w.pathname.startsWith(`/${d}/`)))return;let p=c(w).slice(1);p?(p=p.replace(/\/[^/]+?:.+$/,""),p=De("pages",p.replaceAll("/","+"))):p="site";try{e.isLoading=!0;const d=await e.get(ne(p));e.set(d),e.isLoading=!1}catch(d){console.error(d)}}}function Je(a){return a.charAt(0).toUpperCase()+a.slice(1)}return{__sfc:!0,propsDefinition:oe,props:t,_isKirby5:o,panel:e,api:r,t:s,getNonLocalizedPath:c,DEVICE_VIEWPORT_PRESETS:h,label:u,pageId:f,updateInterval:v,interactable:g,aspectRatio:C,updateStrategy:A,help:ie,isRendering:$,showTransitionIframe:O,hasError:q,blobUrl:_,transitionBlobUrl:re,devicePreview:S,isInsetDevicePreview:M,previewIframeStyles:ae,licenseStatus:se,container:B,iframe:I,transitionIframe:ce,throttledRenderPreview:b,lastRenderedContent:D,eventsController:N,contentChanges:T,isTopbarVisible:K,topbarHeight:j,headerHeight:V,containerHeight:Ke,renderUnsavedContent:k,openPreviewInTab:Ve,setDevicePreview:Ge,updatePreviewStyles:G,renderPreview:le,handleMessage:ue,uppercaseFirst:Je,LicensingButtonGroup:Ce}}});var We=function(){var t=this,o=t._self._c,e=t._self._setupProxy;return o("k-section",{attrs:{label:e.label}},[o("div",{staticClass:"klp-flex klp-items-center klp-gap-2",attrs:{slot:"options"},slot:"options"},[e.licenseStatus!==void 0?o(e.LicensingButtonGroup,{attrs:{label:"Kirby Live Preview","api-namespace":"__live-preview__","license-status":e.licenseStatus,"pricing-url":"https://kirby.tools/live-preview/buy"}}):t._e(),o("k-button-group",{attrs:{layout:"collapsed"}},t._l(Object.keys(e.DEVICE_VIEWPORT_PRESETS),function(r){return o("k-button",{key:r,style:{paddingInline:"calc(var(--input-padding)*2)"},attrs:{variant:"filled",theme:e.devicePreview===r?"blue":void 0,size:"xs",title:e.uppercaseFirst(r),icon:r==="mobile"?"mobile":r==="tablet"?"tablet":"display"},on:{click:function(s){return e.setDevicePreview(r)}}})}),1),o("k-button",{attrs:{variant:"filled",size:"xs",icon:"open",title:e.panel.t("open"),disabled:!e.blobUrl},on:{click:function(r){return e.openPreviewInTab()}}}),o("k-button",{attrs:{variant:"filled",size:"xs",icon:"live-preview-restart"},on:{click:function(r){return e.renderUnsavedContent()}}})],1),o("div",{ref:"container",staticClass:"klp-grid klp-min-h-[55dvh] klp-rounded-[var(--input-rounded)]",class:[e.isRendering&&"klp-pointer-events-none",e.transitionBlobUrl&&!e.hasError&&!e.isInsetDevicePreview&&"k-shadow-md",(!e.transitionBlobUrl||e.hasError)&&"klp-border klp-border-dashed klp-border-[var(--preview-color-border)]",e.devicePreview&&"klp-relative klp-overflow-visible"],style:{"--preview-color-border":e._isKirby5?"light-dark(var(--color-gray-400),var(--color-border))":"var(--color-gray-400)",aspectRatio:e.aspectRatio,height:e.aspectRatio?"auto":e.containerHeight,maxWidth:"100%"},attrs:{"data-theme":"passive"}},[e.transitionBlobUrl?o("iframe",{ref:"transitionIframe",staticClass:"klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[e.hasError&&"klp-pointer-events-none klp-opacity-0",e.showTransitionIframe&&!e.hasError&&e.isInsetDevicePreview&&"k-shadow-md"],style:{gridArea:"1 / 1 / 2 / 2",...e.devicePreview?e.previewIframeStyles:{width:"100%",height:"100%",transform:"none"}},attrs:{src:e.transitionBlobUrl}}):t._e(),e.blobUrl?o("iframe",{ref:"iframe",staticClass:"klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[(e.showTransitionIframe||e.hasError)&&"klp-pointer-events-none klp-opacity-0",!e.showTransitionIframe&&!e.hasError&&e.isInsetDevicePreview&&"k-shadow-md"],style:{gridArea:"1 / 1 / 2 / 2",...e.devicePreview?e.previewIframeStyles:{width:"100%",height:"100%",transform:"none"}},attrs:{src:e.blobUrl}}):t._e(),e.hasError?o("div",{staticClass:"klp-flex klp-items-center klp-justify-center",style:{gridArea:"1 / 1 / 2 / 2"}},[o("k-button",{attrs:{variant:"filled",theme:"notice",icon:"alert",text:e.panel.t("johannschopplich.preview.error.render")},on:{click:function(r){return e.renderUnsavedContent({persistScrollPosition:!1})}}})],1):t._e()]),e.help?o("footer",{staticClass:"klp-mt-[var(--spacing-2)]"},[o("k-text",{staticClass:"k-help",attrs:{html:e.help}})],1):t._e()])},Fe=[],qe=ee(ze,We,Fe,!1,null,"2528f0f1");const Me=qe.exports;window.panel.plugin("johannschopplich/live-preview",{sections:{preview:Me},icons:{"live-preview-restart":'<path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772z" />'}})})();
