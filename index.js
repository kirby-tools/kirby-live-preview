(function(){"use strict";const r=window.Vue;function h(){return window.panel}function H(){return h().api}const q=()=>window.panel.plugins.viewButtons!==void 0;function le(){return q()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):h().app.$store}function ce(){const t=h(),o=le(),n=q(),e=g(n?()=>t.view.props.content:()=>o.getters["content/values"]()),i=g(n?()=>t.content.changes():()=>o.getters["content/changes"]()),a=g(n?()=>Object.keys(i.value).length>0:()=>o.getters["content/hasChanges"]()),c=n?t.content:new Proxy({},{get(){return()=>{}}});return{content:c,currentContent:e,contentChanges:i,hasChanges:a,update:async(p,y=!0)=>{if(!n&&p)for(const[E,z]of Object.entries(p))o.dispatch("content/update",[E,z]);const _=c.merge(p);y&&await c.save(_)}}}function ue(){const t=h();function o(n){return!n||typeof n=="string"?n:n[t.translation.code]??Object.values(n)[0]}return{t:o}}function de(){const t=H();return{load:({parent:n,name:e})=>t.get(`${n}/sections/${e}`)}}const g=r.computed;r.customRef,r.defineAsyncComponent,r.defineComponent,r.effectScope,r.getCurrentInstance,r.getCurrentScope,r.h,r.inject,r.isProxy,r.isReactive,r.isReadonly,r.isRef,r.isShallow,r.markRaw;const M=r.nextTick;r.onActivated,r.onBeforeMount;const G=r.onBeforeUnmount;r.onBeforeUpdate,r.onDeactivated,r.onErrorCaptured;const pe=r.onMounted;r.onRenderTracked,r.onRenderTriggered,r.onScopeDispose,r.onServerPrefetch,r.onUnmounted,r.onUpdated,r.provide,r.proxyRefs,r.reactive,r.readonly;const l=r.ref;r.shallowReactive,r.shallowReadonly,r.shallowRef,r.toRaw,r.toRef,r.toRefs,r.triggerRef;const J=r.unref;r.useAttrs,r.useCssModule,r.useCssVars,r.useListeners,r.useSlots;const Q=r.watch;r.watchEffect,r.watchPostEffect,r.watchSyncEffect;const N={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Find your order number</a> on Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible":"License key invalid for this plugin version","modal.error.upgradeable":"License key invalid for this plugin version. Upgrade now on https://hub.kirby.tools.","modal.error.activated":"License key already activated",activate:"Activate",activated:"Plugin activated",buy:"Buy a license",upgrade:"Upgrade"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Finde deine Bestellnummer</a> bei Lemon Squeezy oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.upgradeable":"Lizenzschlüssel ungültig für diese Plugin-Version. Aktualisiere jetzt auf https://hub.kirby.tools.","modal.error.activated":"Lizenzschlüssel bereits aktiviert",activate:"Aktivieren",activated:"Plugin aktiviert",buy:"Lizenz kaufen",upgrade:"Upgrade"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Trouvez votre numéro de commande</a> sur Lemon Squeezy ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible":"Clé de licence invalide pour cette version du plugin","modal.error.upgradeable":"Clé de licence invalide pour cette version du plugin. Mettez à niveau maintenant sur https://hub.kirby.tools.","modal.error.activated":"Clé de licence déjà activée",activate:"Activer",activated:"Plugin activé",buy:"Acheter une licence",upgrade:"Upgrade"},nl:{"modal.info":"Bedankt voor het kopen van {label}! Voer je e-mailadres en bestelnummer in om je licentie te activeren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Vind je bestelnummer</a> op Lemon Squeezy of <a href="mailto:hello@kirby.tools">neem contact met ons op</a> als je het niet kunt vinden.',"modal.error.required.fields":"E-mailadres en bestelnummer zijn verplicht","modal.error.invalid.unauthorized":"E-mailadres of bestelnummer is onjuist","modal.error.invalid.licenseKey":"Licentiesleutel ongeldig voor dit plug-in","modal.error.incompatible":"Licentiesleutel ongeldig voor deze plug-inversie","modal.error.upgradeable":"Licentiesleutel ongeldig voor deze plug-inversie. Upgrade nu op https://hub.kirby.tools.","modal.error.activated":"Licentiesleutel al geactiveerd",activate:"Activeren",activated:"Plugin geactiveerd",buy:"Koop een licentie",upgrade:"Upgrade"}},ve=["localhost","127.0.0.1","[::1]"],fe=["local","test","ddev.site"];function b(t="",o){var i;const n=window.panel.translation.code,e=((i=N==null?void 0:N[n])==null?void 0:i[t])??t;return o?me(e,o):e}function me(t,o,n){return t.replace(/\{(\w+)\}/g,(e,i)=>o[i]||i)}function he(){const{hostname:t}=window.location,o=ve.includes(t),n=fe.some(e=>t.endsWith(`.${e}`));return o||n}const X={Unauthorized:"modal.error.invalid.unauthorized","License key not valid for this plugin":"modal.error.invalid.licenseKey","License key not valid for this plugin version":"modal.error.incompatible","License key not valid for this plugin version, please upgrade your license":"modal.error.upgradeable","License key already activated":"modal.error.activated"};function ge(t){const o=h();return{isLocalhost:he(),assertActivationIntegrity:async({component:a,licenseStatus:c})=>{if(J(c)==="active")return;const d=J(a);if(!(d!=null&&d.$el)||window.getComputedStyle(d.$el).display==="none"||window.getComputedStyle(d.$el).visibility==="hidden"||window.getComputedStyle(d.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let a=!1;const{label:c}=t,d={info:{type:"info",text:b("modal.info",{label:c})},email:{label:o.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:b("modal.fields.orderId.help",{label:c})}};return new Promise(p=>{o.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:b("activate",{label:c})},fields:d},on:{close:()=>{p({isLicenseActive:a})},submit:async y=>{a=await be(y,t),a&&(o.dialog.close(),o.notification.success(b("activated")))}}})})}}}async function be(t,o){const n=h(),{email:e,orderId:i}=t;if(!e||!i)return n.notification.error(b("modal.error.required.fields")),!1;try{const a=await n.api.post(`${o.apiNamespace}/activate`,{email:e,orderId:Number(i)});if((a==null?void 0:a.status)!=="ok")throw new Error("Failed to activate license key");return!0}catch(a){const c=a.message;return n.notification.error(X[c]?b(X[c]):c),!1}}const ye=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(t){const o=t,{openLicenseModal:n,assertActivationIntegrity:e}=ge({label:o.label,apiNamespace:o.apiNamespace}),i=l(o.licenseStatus),a=l();pe(()=>{e({component:a,licenseStatus:o.licenseStatus})});async function c(){const{isLicenseActive:d}=await n();d&&window.location.reload()}return{__sfc:!0,props:o,openLicenseModal:n,assertActivationIntegrity:e,currentLicenseStatus:i,licenseButtonGroup:a,handleRegistration:c,t:b}}});function Y(t,o,n,e,i,a,c,d){var p=typeof t=="function"?t.options:t;return o&&(p.render=o,p.staticRenderFns=n,p._compiled=!0),a&&(p._scopeId="data-v-"+a),{exports:t,options:p}}var we=function(){var o=this,n=o._self._c,e=o._self._setupProxy;return e.currentLicenseStatus!=="active"?n("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":o.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(i){return e.handleRegistration()}}})],1):o._e()},ke=[],_e=Y(ye,we,ke,!1,null,null);const Le=_e.exports,Se={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number};function xe(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Ce(t,o){if(typeof t!="function")throw new TypeError(`Expected the first argument to be a \`function\`, got \`${typeof t}\`.`);let n,e=0;return function(...a){clearTimeout(n);const c=Date.now(),d=c-e,p=o-d;p<=0?(e=c,t.apply(this,a)):n=setTimeout(()=>{e=Date.now(),t.apply(this,a)},p)}}var Ee=Ce;const ze=xe(Ee),Ie=/^\.?\//;function Re(t="",o){return t.endsWith("/")?t:t+"/"}function Pe(t=""){return t.startsWith("/")}function Z(t=""){return Pe(t)?t:"/"+t}function Ue(t){return t&&t!=="/"}function Ae(t,...o){let n=t||"";for(const e of o.filter(i=>Ue(i)))if(n){const i=e.replace(Ie,"");n=Re(n)+i}else n=e;return n}function Te(){const o=h().languages.map(e=>e.code);return{locales:o,getNonLocalizedPath:e=>{const a=(e instanceof URL?e:new URL(e)).pathname.split("/").filter(Boolean);return o.includes(a[0])&&a.shift(),Z(a.join("/"))}}}const $e="__live-preview__/context";let U,C;function je(){return U||C||(C=window.panel.api.get($e).then(t=>(U=t,C=void 0,U)),C)}const ee={...Se},Be=Object.assign({inheritAttrs:!1},{__name:"LivePreview",props:ee,setup(t){const o=t,n=q(),e=h(),i=H(),{t:a}=ue(),{getNonLocalizedPath:c}=Te(),d={mobile:390,tablet:768,desktop:1440},p=l(),y=l(),_=l(),E=l(),z=l(),A=l(),te=l(),T=l(!1),$=l(!1),D=l(!1),w=l(),ne=l(),L=l(),oe=l({}),re=l(),j=l(),I=l(),ie=l();let f,B;const O=new AbortController,{contentChanges:R}=ce();Q(R,s=>{f&&_.value!==!1&&A.value==="interval"&&JSON.stringify(s)!==B&&f(s)}),Q(()=>e.language.code,()=>{k()});const V=l(!0),F=l(32),K=l(65),Ne=g(()=>`calc(100dvh - ${V.value?`calc(${F.value}px + 5.75rem)`:"2vh"} - ${K.value}px - 2.75rem`);(async()=>{const{load:s}=de(),[m,u]=await Promise.all([je(),s({parent:o.parent,name:o.name})]);p.value=a(u.label)||e.t("johannschopplich.preview.label"),y.value=u.pageId,_.value=u.updateInterval,E.value=u.interactable,z.value=u.aspectRatio||void 0,A.value=u.updateStrategy,te.value=u.help,re.value=m.licenseStatus,f=ze(ae,_.value||500),k(),await M();const v=document.querySelector(".k-topbar"),P=document.querySelector(".k-header");if(!z.value&&v&&P){F.value=v.offsetHeight,K.value=P.offsetHeight;const S=new IntersectionObserver(([x])=>{V.value=x.isIntersecting,x.isIntersecting&&(F.value=x.target.offsetHeight),W()},{threshold:[0],rootMargin:"64px 0px 0px 0px"});S.observe(v),G(S.disconnect)}window.addEventListener("message",se,{signal:O.signal}),e.events.on("page.changeTitle",k),e.events.on("file.sort",k),A.value==="blur"&&document.body.addEventListener("blur",()=>{JSON.stringify(R.value)!==B&&(f==null||f(R.value))},{capture:!0,signal:O.signal})})(),G(()=>{O.abort(),e.events.off("page.changeTitle",k),e.events.off("file.sort",k),w.value&&URL.revokeObjectURL(w.value)});function k(s){f==null||f(R.value,s)}function De(){const s=new URL(w.value);window.open(s,"_blank")}function Ve(s){L.value=s===L.value?void 0:s,W()}async function W(){if(await M(),!j.value||!L.value||!(L.value in d))return;const s=d[L.value],m=j.value.clientWidth,u=j.value.clientHeight,v=m/s;oe.value={width:`${s}px`,height:`${u/v}px`,transform:`scale(${v})`,transformOrigin:"top center",position:"absolute",top:0,left:"50%",marginLeft:`${-s/2}px`}}async function ae(s,{persistScrollPosition:m=!0}={}){var v,P;if(T.value)return;T.value=!0;let u=0;I.value&&(u=I.value.contentWindow.scrollY,(P=(v=ie.value)==null?void 0:v.contentWindow)==null||P.scrollTo(0,u)),$.value=!0;try{const{data:S}=await i.post("__live-preview__/render",{pageId:y.value,content:s,interactable:E.value,model:e.view.path==="site"?"site":"page"}),x=w.value,We=new Blob([S],{type:"text/html"});w.value=URL.createObjectURL(We),await M(),await new Promise(He=>{I.value.addEventListener("load",()=>{u&&m&&I.value.contentWindow.scrollTo(0,u),He()},{once:!0})}),$.value=!1,D.value=!1,ne.value=w.value,B=JSON.stringify(s),x&&URL.revokeObjectURL(x)}catch(S){console.error(S),D.value=!0,$.value=!1}finally{T.value=!1}}async function se({data:s}){if(s.type==="save"){e.events.emit(`${e.context}.save`);return}if(s.type==="link"){const m=new URL(s.href);if(m.origin!==window.location.origin){window.open(s.href,"_blank");return}if(["assets","media"].some(v=>m.pathname.startsWith(`/${v}/`)))return;let u=c(m).slice(1);u?(u=u.replace(/\/[^/]+?:.+$/,""),u=Ae("pages",u.replaceAll("/","+"))):u="site";try{e.isLoading=!0;const v=await e.get(Z(u));e.set(v),e.isLoading=!1}catch(v){console.error(v)}}}function Ke(s){return s.charAt(0).toUpperCase()+s.slice(1)}return{__sfc:!0,propsDefinition:ee,props:o,_isKirby5:n,panel:e,api:i,t:a,getNonLocalizedPath:c,DEVICE_VIEWPORT_PRESETS:d,label:p,pageId:y,updateInterval:_,interactable:E,aspectRatio:z,updateStrategy:A,help:te,isRendering:T,showTransitionIframe:$,hasError:D,blobUrl:w,transitionBlobUrl:ne,devicePreview:L,previewIframeStyles:oe,licenseStatus:re,container:j,iframe:I,transitionIframe:ie,throttledRenderPreview:f,lastRenderedContent:B,eventsController:O,contentChanges:R,isTopbarVisible:V,topbarHeight:F,headerHeight:K,containerHeight:Ne,renderUnsavedContent:k,openPreviewInTab:De,setDevicePreview:Ve,updatePreviewStyles:W,renderPreview:ae,handleMessage:se,uppercaseFirst:Ke,LicensingButtonGroup:Le}}});var Oe=function(){var o=this,n=o._self._c,e=o._self._setupProxy;return n("k-section",{attrs:{label:e.label}},[n("div",{staticClass:"klp-flex klp-items-center klp-gap-2",attrs:{slot:"options"},slot:"options"},[e.licenseStatus!==void 0?n(e.LicensingButtonGroup,{attrs:{label:"Kirby Live Preview","api-namespace":"__live-preview__","license-status":e.licenseStatus,"pricing-url":"https://kirby.tools/live-preview#pricing"}}):o._e(),n("k-button-group",{attrs:{layout:"collapsed"}},o._l(Object.keys(e.DEVICE_VIEWPORT_PRESETS),function(i){return n("k-button",{key:i,style:{paddingInline:"calc(var(--input-padding)*2)"},attrs:{variant:"filled",theme:e.devicePreview===i?"blue":void 0,size:"xs",title:e.uppercaseFirst(i),icon:i==="mobile"?"mobile":i==="tablet"?"tablet":"display"},on:{click:function(a){return e.setDevicePreview(i)}}})}),1),n("k-button",{attrs:{variant:"filled",size:"xs",icon:"open",title:e.panel.t("open"),disabled:!e.blobUrl},on:{click:function(i){return e.openPreviewInTab()}}}),n("k-button",{attrs:{variant:"filled",size:"xs",icon:"live-preview-restart"},on:{click:function(i){return e.renderUnsavedContent()}}})],1),n("div",{ref:"container",staticClass:"klp-grid klp-min-h-[55dvh] klp-rounded-[var(--input-rounded)]",class:[e.isRendering&&"klp-pointer-events-none",e.transitionBlobUrl&&!e.hasError&&"k-shadow-md",(!e.transitionBlobUrl||e.hasError)&&"klp-border klp-border-dashed klp-border-[var(--preview-color-border)]",e.devicePreview&&"klp-relative klp-overflow-hidden"],style:{"--preview-color-border":e._isKirby5?"light-dark(var(--color-gray-400),var(--color-border))":"var(--color-gray-400)",aspectRatio:e.aspectRatio,height:e.aspectRatio?"auto":e.containerHeight,maxWidth:"100%"},attrs:{"data-theme":"passive"}},[e.transitionBlobUrl?n("iframe",{ref:"transitionIframe",staticClass:"klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[e.hasError&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1",...e.devicePreview?e.previewIframeStyles:{width:"100%",height:"100%",transform:"none"}},attrs:{src:e.transitionBlobUrl}}):o._e(),e.blobUrl?n("iframe",{ref:"iframe",staticClass:"klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[(e.showTransitionIframe||e.hasError)&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1",...e.devicePreview?e.previewIframeStyles:{width:"100%",height:"100%",transform:"none"}},attrs:{src:e.blobUrl}}):o._e(),e.hasError?n("div",{staticClass:"klp-flex klp-items-center klp-justify-center",style:{gridArea:"1 / 1"}},[n("k-button",{attrs:{variant:"filled",theme:"notice",icon:"alert",text:e.panel.t("johannschopplich.preview.error.render")},on:{click:function(i){return e.renderUnsavedContent({persistScrollPosition:!1})}}})],1):o._e()]),e.help?n("k-text",{staticClass:"k-help klp-mt-2",attrs:{html:e.help}}):o._e()],1)},Fe=[],qe=Y(Be,Oe,Fe,!1,null,"b14f1fbc");const Me=qe.exports;window.panel.plugin("johannschopplich/live-preview",{sections:{preview:Me},icons:{"live-preview-restart":'<path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772z" />'}})})();
