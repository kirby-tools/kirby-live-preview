(function(){"use strict";const o=window.Vue;function h(){return window.panel}function G(){return h().api}const F=()=>window.panel.plugins.viewButtons!==void 0;function ce(){return F()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):h().app.$store}function ue(){const t=h(),r=ce(),n=F();if(n&&!("diff"in t.content))throw new Error("This plugin requires Kirby 5.0.0-rc.1 or higher. Please update your Kirby installation.");const e=g(n?()=>t.content.version("changes"):()=>r.getters["content/values"]()),i=g(n?()=>t.content.diff():()=>r.getters["content/changes"]()),a=g(n?()=>t.content.hasDiff():()=>r.getters["content/hasChanges"]()),c=n?t.content:new Proxy({},{get(){return()=>{}}});return{content:c,currentContent:e,contentChanges:i,hasChanges:a,update:async(p,y=!0)=>{if(!n&&p)for(const[E,I]of Object.entries(p))r.dispatch("content/update",[E,I]);const _=c.merge(p);y&&await c.save(_)}}}function de(){const t=h();function r(n){return!n||typeof n=="string"?n:n[t.translation.code]??Object.values(n)[0]}return{t:r}}function pe(){const t=G();return{load:({parent:n,name:e})=>t.get(`${n}/sections/${e}`)}}const g=o.computed;o.customRef,o.defineAsyncComponent,o.defineComponent,o.effectScope,o.getCurrentInstance,o.getCurrentScope,o.h,o.inject,o.isProxy,o.isReactive,o.isReadonly,o.isRef,o.isShallow,o.markRaw;const q=o.nextTick;o.onActivated,o.onBeforeMount;const J=o.onBeforeUnmount;o.onBeforeUpdate,o.onDeactivated,o.onErrorCaptured;const ve=o.onMounted;o.onRenderTracked,o.onRenderTriggered,o.onScopeDispose,o.onServerPrefetch,o.onUnmounted,o.onUpdated,o.provide,o.proxyRefs,o.reactive,o.readonly;const l=o.ref;o.shallowReactive,o.shallowReadonly,o.shallowRef,o.toRaw,o.toRef,o.toRefs,o.triggerRef;const Q=o.unref;o.useAttrs,o.useCssModule,o.useCssVars,o.useListeners,o.useSlots;const X=o.watch;o.watchEffect,o.watchPostEffect,o.watchSyncEffect;const M={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Find your order number</a> on Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible":"License key invalid for this plugin version","modal.error.upgradeable":"License key invalid for this plugin version. Upgrade now on https://hub.kirby.tools.","modal.error.activated":"License key already activated",activate:"Activate",activated:"Plugin activated",buy:"Buy a license",upgrade:"Upgrade"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Finde deine Bestellnummer</a> bei Lemon Squeezy oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.upgradeable":"Lizenzschlüssel ungültig für diese Plugin-Version. Aktualisiere jetzt auf https://hub.kirby.tools.","modal.error.activated":"Lizenzschlüssel bereits aktiviert",activate:"Aktivieren",activated:"Plugin aktiviert",buy:"Lizenz kaufen",upgrade:"Upgrade"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Trouvez votre numéro de commande</a> sur Lemon Squeezy ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible":"Clé de licence invalide pour cette version du plugin","modal.error.upgradeable":"Clé de licence invalide pour cette version du plugin. Mettez à niveau maintenant sur https://hub.kirby.tools.","modal.error.activated":"Clé de licence déjà activée",activate:"Activer",activated:"Plugin activé",buy:"Acheter une licence",upgrade:"Upgrade"},nl:{"modal.info":"Bedankt voor het kopen van {label}! Voer je e-mailadres en bestelnummer in om je licentie te activeren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Vind je bestelnummer</a> op Lemon Squeezy of <a href="mailto:hello@kirby.tools">neem contact met ons op</a> als je het niet kunt vinden.',"modal.error.required.fields":"E-mailadres en bestelnummer zijn verplicht","modal.error.invalid.unauthorized":"E-mailadres of bestelnummer is onjuist","modal.error.invalid.licenseKey":"Licentiesleutel ongeldig voor dit plug-in","modal.error.incompatible":"Licentiesleutel ongeldig voor deze plug-inversie","modal.error.upgradeable":"Licentiesleutel ongeldig voor deze plug-inversie. Upgrade nu op https://hub.kirby.tools.","modal.error.activated":"Licentiesleutel al geactiveerd",activate:"Activeren",activated:"Plugin geactiveerd",buy:"Koop een licentie",upgrade:"Upgrade"}},fe=["localhost","127.0.0.1","[::1]"],me=["local","test","ddev.site"];function b(t="",r){var i;const n=window.panel.translation.code,e=((i=M==null?void 0:M[n])==null?void 0:i[t])??t;return r?he(e,r):e}function he(t,r,n){return t.replace(/\{(\w+)\}/g,(e,i)=>r[i]||i)}function ge(){const{hostname:t}=window.location,r=fe.includes(t),n=me.some(e=>t.endsWith(`.${e}`));return r||n}const Y={Unauthorized:"modal.error.invalid.unauthorized","License key not valid for this plugin":"modal.error.invalid.licenseKey","License key not valid for this plugin version":"modal.error.incompatible","License key not valid for this plugin version, please upgrade your license":"modal.error.upgradeable","License key already activated":"modal.error.activated"};function be(t){const r=h();return{isLocalhost:ge(),assertActivationIntegrity:async({component:a,licenseStatus:c})=>{if(Q(c)==="active")return;const d=Q(a);if(!(d!=null&&d.$el)||window.getComputedStyle(d.$el).display==="none"||window.getComputedStyle(d.$el).visibility==="hidden"||window.getComputedStyle(d.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let a=!1;const{label:c}=t,d={info:{type:"info",text:b("modal.info",{label:c})},email:{label:r.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:b("modal.fields.orderId.help",{label:c})}};return new Promise(p=>{r.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:b("activate",{label:c})},fields:d},on:{close:()=>{p({isLicenseActive:a})},submit:async y=>{a=await ye(y,t),a&&(r.dialog.close(),r.notification.success(b("activated")))}}})})}}}async function ye(t,r){const n=h(),{email:e,orderId:i}=t;if(!e||!i)return n.notification.error(b("modal.error.required.fields")),!1;try{const a=await n.api.post(`${r.apiNamespace}/activate`,{email:e,orderId:Number(i)});if((a==null?void 0:a.status)!=="ok")throw new Error("Failed to activate license key");return!0}catch(a){const c=a.message;return n.notification.error(Y[c]?b(Y[c]):c),!1}}const we=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(t){const r=t,{openLicenseModal:n,assertActivationIntegrity:e}=be({label:r.label,apiNamespace:r.apiNamespace}),i=l(r.licenseStatus),a=l();ve(()=>{e({component:a,licenseStatus:r.licenseStatus})});async function c(){const{isLicenseActive:d}=await n();d&&window.location.reload()}return{__sfc:!0,props:r,openLicenseModal:n,assertActivationIntegrity:e,currentLicenseStatus:i,licenseButtonGroup:a,handleRegistration:c,t:b}}});function Z(t,r,n,e,i,a,c,d){var p=typeof t=="function"?t.options:t;return r&&(p.render=r,p.staticRenderFns=n,p._compiled=!0),a&&(p._scopeId="data-v-"+a),{exports:t,options:p}}var ke=function(){var r=this,n=r._self._c,e=r._self._setupProxy;return e.currentLicenseStatus!=="active"?n("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":r.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(i){return e.handleRegistration()}}})],1):r._e()},_e=[],Le=Z(we,ke,_e,!1,null,null);const Se=Le.exports,xe={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number};function Ce(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Ee(t,r){if(typeof t!="function")throw new TypeError(`Expected the first argument to be a \`function\`, got \`${typeof t}\`.`);let n,e=0;return function(...a){clearTimeout(n);const c=Date.now(),d=c-e,p=r-d;p<=0?(e=c,t.apply(this,a)):n=setTimeout(()=>{e=Date.now(),t.apply(this,a)},p)}}var Ie=Ee;const Pe=Ce(Ie),ze=/^\.?\//;function Re(t="",r){return t.endsWith("/")?t:t+"/"}function Ue(t=""){return t.startsWith("/")}function ee(t=""){return Ue(t)?t:"/"+t}function Ae(t){return t&&t!=="/"}function Te(t,...r){let n=t||"";for(const e of r.filter(i=>Ae(i)))if(n){const i=e.replace(ze,"");n=Re(n)+i}else n=e;return n}function $e(){const r=h().languages.map(e=>e.code);return{locales:r,getNonLocalizedPath:e=>{const a=(e instanceof URL?e:new URL(e)).pathname.split("/").filter(Boolean);return r.includes(a[0])&&a.shift(),ee(a.join("/"))}}}const Be="__live-preview__/context";let U,C;function je(){return U||C||(C=window.panel.api.get(Be).then(t=>(U=t,C=void 0,U)),C)}const te={...xe},Oe=Object.assign({inheritAttrs:!1},{__name:"LivePreview",props:te,setup(t){const r=t,n=F(),e=h(),i=G(),{t:a}=de(),{getNonLocalizedPath:c}=$e(),d={mobile:390,tablet:768,desktop:1440},p=l(),y=l(),_=l(),E=l(),I=l(),A=l(),ne=l(),T=l(!1),$=l(!1),N=l(!1),w=l(),re=l(),L=l(),K=l(!1),oe=l({}),ie=l(),B=l(),P=l(),ae=l();let f,j;const O=new AbortController,{contentChanges:z}=ue();X(z,s=>{f&&_.value!==!1&&A.value==="interval"&&JSON.stringify(s)!==j&&f(s)}),X(()=>e.language.code,()=>{k()});const V=l(!0),D=l(32),W=l(65),Ne=g(()=>`calc(100dvh - ${V.value?`calc(${D.value}px + 5.75rem)`:"2vh"} - ${W.value}px - 2.75rem`);(async()=>{const{load:s}=pe(),[m,u]=await Promise.all([je(),s({parent:r.parent,name:r.name})]);p.value=a(u.label)||e.t("johannschopplich.preview.label"),y.value=u.pageId,_.value=u.updateInterval,E.value=u.interactable,I.value=u.aspectRatio||void 0,A.value=u.updateStrategy,ne.value=u.help,ie.value=m.licenseStatus,f=Pe(se,_.value||500),k(),await q();const v=document.querySelector(".k-topbar"),R=document.querySelector(".k-header");if(!I.value&&v&&R){D.value=v.offsetHeight,W.value=R.offsetHeight;const S=new IntersectionObserver(([x])=>{V.value=x.isIntersecting,x.isIntersecting&&(D.value=x.target.offsetHeight),H()},{threshold:[0],rootMargin:"64px 0px 0px 0px"});S.observe(v),J(S.disconnect)}window.addEventListener("message",le,{signal:O.signal}),e.events.on("page.changeTitle",k),e.events.on("file.sort",k),A.value==="blur"&&document.body.addEventListener("blur",()=>{JSON.stringify(z.value)!==j&&(f==null||f(z.value))},{capture:!0,signal:O.signal})})(),J(()=>{O.abort(),e.events.off("page.changeTitle",k),e.events.off("file.sort",k),w.value&&URL.revokeObjectURL(w.value)});function k(s){f==null||f(z.value,s)}function Ke(){const s=new URL(w.value);window.open(s,"_blank")}function Ve(s){L.value=s===L.value?void 0:s,H()}async function H(){if(await q(),!B.value||!L.value||!(L.value in d)){K.value=!1;return}const s=d[L.value],m=B.value.clientWidth,u=B.value.clientHeight,v=m/s;K.value=s<m,oe.value={width:`${s}px`,height:v<1?`${u/v}px`:"100%",transform:v<1?`scale(${v})`:"none",transformOrigin:"top center",position:"absolute",top:0,left:"50%",marginLeft:`${-s/2}px`}}async function se(s,{persistScrollPosition:m=!0}={}){var v,R;if(T.value)return;T.value=!0;let u=0;P.value&&(u=P.value.contentWindow.scrollY,(R=(v=ae.value)==null?void 0:v.contentWindow)==null||R.scrollTo(0,u)),$.value=!0;try{const{data:S}=await i.post("__live-preview__/render",{pageId:y.value,content:s,interactable:E.value,model:e.view.path==="site"?"site":"page"}),x=w.value,He=new Blob([S],{type:"text/html"});w.value=URL.createObjectURL(He),await q(),await new Promise(Ge=>{P.value.addEventListener("load",()=>{u&&m&&P.value.contentWindow.scrollTo(0,u),Ge()},{once:!0})}),$.value=!1,N.value=!1,re.value=w.value,j=JSON.stringify(s),x&&URL.revokeObjectURL(x)}catch(S){console.error(S),N.value=!0,$.value=!1}finally{T.value=!1}}async function le({data:s}){if(s.type==="save"){e.events.emit(`${e.context}.save`);return}if(s.type==="link"){const m=new URL(s.href);if(m.origin!==window.location.origin){window.open(s.href,"_blank");return}if(["assets","media"].some(v=>m.pathname.startsWith(`/${v}/`)))return;let u=c(m).slice(1);u?(u=u.replace(/\/[^/]+?:.+$/,""),u=Te("pages",u.replaceAll("/","+"))):u="site";try{e.isLoading=!0;const v=await e.get(ee(u));e.set(v),e.isLoading=!1}catch(v){console.error(v)}}}function We(s){return s.charAt(0).toUpperCase()+s.slice(1)}return{__sfc:!0,propsDefinition:te,props:r,_isKirby5:n,panel:e,api:i,t:a,getNonLocalizedPath:c,DEVICE_VIEWPORT_PRESETS:d,label:p,pageId:y,updateInterval:_,interactable:E,aspectRatio:I,updateStrategy:A,help:ne,isRendering:T,showTransitionIframe:$,hasError:N,blobUrl:w,transitionBlobUrl:re,devicePreview:L,isInsetDevicePreview:K,previewIframeStyles:oe,licenseStatus:ie,container:B,iframe:P,transitionIframe:ae,throttledRenderPreview:f,lastRenderedContent:j,eventsController:O,contentChanges:z,isTopbarVisible:V,topbarHeight:D,headerHeight:W,containerHeight:Ne,renderUnsavedContent:k,openPreviewInTab:Ke,setDevicePreview:Ve,updatePreviewStyles:H,renderPreview:se,handleMessage:le,uppercaseFirst:We,LicensingButtonGroup:Se}}});var De=function(){var r=this,n=r._self._c,e=r._self._setupProxy;return n("k-section",{attrs:{label:e.label}},[n("div",{staticClass:"klp-flex klp-items-center klp-gap-2",attrs:{slot:"options"},slot:"options"},[e.licenseStatus!==void 0?n(e.LicensingButtonGroup,{attrs:{label:"Kirby Live Preview","api-namespace":"__live-preview__","license-status":e.licenseStatus,"pricing-url":"https://kirby.tools/live-preview/buy"}}):r._e(),n("k-button-group",{attrs:{layout:"collapsed"}},r._l(Object.keys(e.DEVICE_VIEWPORT_PRESETS),function(i){return n("k-button",{key:i,style:{paddingInline:"calc(var(--input-padding)*2)"},attrs:{variant:"filled",theme:e.devicePreview===i?"blue":void 0,size:"xs",title:e.uppercaseFirst(i),icon:i==="mobile"?"mobile":i==="tablet"?"tablet":"display"},on:{click:function(a){return e.setDevicePreview(i)}}})}),1),n("k-button",{attrs:{variant:"filled",size:"xs",icon:"open",title:e.panel.t("open"),disabled:!e.blobUrl},on:{click:function(i){return e.openPreviewInTab()}}}),n("k-button",{attrs:{variant:"filled",size:"xs",icon:"live-preview-restart"},on:{click:function(i){return e.renderUnsavedContent()}}})],1),n("div",{ref:"container",staticClass:"klp-grid klp-min-h-[55dvh] klp-rounded-[var(--input-rounded)]",class:[e.isRendering&&"klp-pointer-events-none",e.transitionBlobUrl&&!e.hasError&&!e.isInsetDevicePreview&&"k-shadow-md",(!e.transitionBlobUrl||e.hasError)&&"klp-border klp-border-dashed klp-border-[var(--preview-color-border)]",e.devicePreview&&"klp-relative klp-overflow-visible"],style:{"--preview-color-border":e._isKirby5?"light-dark(var(--color-gray-400),var(--color-border))":"var(--color-gray-400)",aspectRatio:e.aspectRatio,height:e.aspectRatio?"auto":e.containerHeight,maxWidth:"100%"},attrs:{"data-theme":"passive"}},[e.transitionBlobUrl?n("iframe",{ref:"transitionIframe",staticClass:"klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[e.hasError&&"klp-pointer-events-none klp-opacity-0",e.showTransitionIframe&&!e.hasError&&e.isInsetDevicePreview&&"k-shadow-md"],style:{gridArea:"1 / 1 / 2 / 2",...e.devicePreview?e.previewIframeStyles:{width:"100%",height:"100%",transform:"none"}},attrs:{src:e.transitionBlobUrl}}):r._e(),e.blobUrl?n("iframe",{ref:"iframe",staticClass:"klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[(e.showTransitionIframe||e.hasError)&&"klp-pointer-events-none klp-opacity-0",!e.showTransitionIframe&&!e.hasError&&e.isInsetDevicePreview&&"k-shadow-md"],style:{gridArea:"1 / 1 / 2 / 2",...e.devicePreview?e.previewIframeStyles:{width:"100%",height:"100%",transform:"none"}},attrs:{src:e.blobUrl}}):r._e(),e.hasError?n("div",{staticClass:"klp-flex klp-items-center klp-justify-center",style:{gridArea:"1 / 1 / 2 / 2"}},[n("k-button",{attrs:{variant:"filled",theme:"notice",icon:"alert",text:e.panel.t("johannschopplich.preview.error.render")},on:{click:function(i){return e.renderUnsavedContent({persistScrollPosition:!1})}}})],1):r._e()]),e.help?n("footer",{staticClass:"klp-mt-[var(--spacing-2)]"},[n("k-text",{staticClass:"k-help",attrs:{html:e.help}})],1):r._e()])},Fe=[],qe=Z(Oe,De,Fe,!1,null,"2528f0f1");const Me=qe.exports;window.panel.plugin("johannschopplich/live-preview",{sections:{preview:Me},icons:{"live-preview-restart":'<path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772z" />'}})})();
