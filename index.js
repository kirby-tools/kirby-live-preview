(function(){"use strict";function b(){return window.panel}function U(){return b().api}function Y(){const o=U();return{load:({parent:e,name:n})=>o.get(`${e}/sections/${n}`)}}function X(){return b().app.$store}const t=window.Vue,Z=t.computed;t.customRef,t.defineAsyncComponent,t.defineComponent,t.effectScope,t.getCurrentInstance,t.getCurrentScope,t.h,t.inject,t.isProxy,t.isReactive,t.isReadonly,t.isRef,t.isShallow,t.markRaw;const A=t.nextTick;t.onActivated,t.onBeforeMount;const ee=t.onBeforeUnmount;t.onBeforeUpdate,t.onDeactivated,t.onErrorCaptured,t.onMounted,t.onRenderTracked,t.onRenderTriggered,t.onScopeDispose,t.onServerPrefetch,t.onUnmounted,t.onUpdated,t.provide,t.proxyRefs,t.reactive,t.readonly;const l=t.ref;t.shallowReactive,t.shallowReadonly,t.shallowRef,t.toRaw,t.toRef,t.toRefs,t.triggerRef;const $=t.unref;t.useAttrs,t.useCssModule,t.useCssVars,t.useListeners,t.useSlots;const T=t.watch;t.watchEffect,t.watchPostEffect,t.watchSyncEffect;const te={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number};function ne(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function oe(o,r){if(typeof o!="function")throw new TypeError(`Expected the first argument to be a \`function\`, got \`${typeof o}\`.`);let e,n=0;return function(...c){clearTimeout(e);const v=Date.now(),k=v-n,s=r-k;s<=0?(n=v,o.apply(this,c)):e=setTimeout(()=>{n=Date.now(),o.apply(this,c)},s)}}var re=oe;const ie=ne(re),ae=/^\.?\//;function se(o="",r){return o.endsWith("/")?o:o+"/"}function le(o=""){return o.startsWith("/")}function M(o=""){return le(o)?o:"/"+o}function ce(o){return o&&o!=="/"}function de(o,...r){let e=o||"";for(const n of r.filter(a=>ce(a)))if(e){const a=n.replace(ae,"");e=se(e)+a}else e=n;return e}const I={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Get your order number</a> from Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible.licenseKey":"License key invalid for this plugin version","modal.error.registered":"License key already registered",activate:"Activate",activated:"Plugin activated"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'Rufe die <a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Bestellnummer von Lemon Squeezy ab</a> oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible.licenseKey":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.registered":"Lizenzschlüssel bereits registriert",activate:"Aktivieren",activated:"Plugin aktiviert"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'Obtenez votre numéro de commande sur <a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Lemon Squeezy</a> ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible.licenseKey":"Clé de licence invalide pour cette version du plugin","modal.error.registered":"Clé de licence déjà enregistrée",activate:"Activer",activated:"Plugin activé"}};function h(o,r,e){var v;const a=b().translation.code,c=((v=I==null?void 0:I[a])==null?void 0:v[o])??e;if(c)return r?ue(c,r):c}function ue(o,r,e){return o.replace(/\{(\w+)\}/g,(n,a)=>r[a]||a)}const pe=["localhost","127.0.0.1","[::1]"],fe=["local","test","ddev.site"];function ve({label:o,apiNamespace:r}){const e=b(),n=U(),a=me(),c=async(s,f)=>{if(!s||!f)throw new Error("Email and order ID are required");const d=await n.post(`${r}/register`,{email:s,orderId:f});if((d==null?void 0:d.status)!=="ok")throw new Error("Registration failed");return!0};return{isLocalhost:a,assertActivationIntegrity:async({component:s,licenseStatus:f})=>{if($(f)==="active")return;await A();const d=$(s);if(!(d!=null&&d.$el)||window.getComputedStyle(d.$el).display==="none"||window.getComputedStyle(d.$el).visibility==="hidden"||window.getComputedStyle(d.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let s=!1;return new Promise(f=>{e.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:h("activate",{label:o})},fields:{info:{type:"info",text:h("modal.info",{label:o})},email:{label:e.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:h("modal.fields.orderId.help",{label:o})}}},on:{close:()=>{f({isRegistered:s})},submit:async d=>{const{email:L,orderId:R}=d;if(!L||!R){e.notification.error(h("modal.error.required.fields"));return}try{await c(L,Number(R))}catch(x){let p=x.message;p==="Unauthorized"?p=h("modal.error.invalid.unauthorized"):p==="License key not valid for this plugin"?p=h("modal.error.invalid.licenseKey"):p==="License key not valid for this plugin version"?p=h("modal.error.incompatible.licenseKey"):p==="License key already registered"&&(p=h("modal.error.registered")),e.notification.error(p);return}s=!0,e.dialog.close(),e.notification.success(h("activated"))}}})})}}}function me(){const{hostname:o}=window.location,r=pe.includes(o),e=fe.some(n=>o.endsWith(`.${n}`));return r||e}function he(){const r=b().languages.map(n=>n.code);return{locales:r,getNonLocalizedPath:n=>{const c=(n instanceof URL?n:new URL(n)).pathname.split("/").filter(Boolean);return r.includes(c[0])&&c.shift(),M(c.join("/"))}}}const ge=["error","warn","info","debug"];function we(o,r,e,n,a,c,v,k){var s=typeof o=="function"?o.options:o;return r&&(s.render=r,s.staticRenderFns=e,s._compiled=!0),s._scopeId="data-v-"+c,{exports:o,options:s}}const D={...te},ye=Object.assign({inheritAttrs:!1},{__name:"Preview",props:D,setup(o){const r=o,e=b(),n=U(),a=X(),{getNonLocalizedPath:c}=he(),{openLicenseModal:v,assertActivationIntegrity:k}=ve({label:"Kirby Live Preview",apiNamespace:"__live-preview__"}),s=l(),f=l(),d=l(),L=l(),R=l(),x=l(),p=l(),C=l(!1),S=l(!1),P=l(!1),_=l(),F=l(),q=l({}),N=l(),E=l(),K=l(),W=l();let w;const B=Z(()=>a.getters["content/changes"]());T(B,(i,u)=>{w&&f.value!==!1&&JSON.stringify(i)!==JSON.stringify(u)&&w(i)},{deep:!0}),T(()=>e.language.code,()=>{y()}),(async()=>{const{load:i}=Y(),u=await i({parent:r.parent,name:r.name});s.value=V(u.label)||e.t("johannschopplich.preview.label"),f.value=u.updateInterval,d.value=u.interactable,L.value=u.aspectRatio||void 0,R.value=ge.indexOf(u.logLevel),x.value=u.help,p.value=u.license,k({component:W,licenseStatus:p.value}),w=ie(G,f.value||250),y(),await A(),L.value||(z(),window.addEventListener("resize",z)),window.addEventListener("message",j),e.events.on("page.changeTitle",y),e.events.on("file.sort",y)})(),ee(()=>{window.removeEventListener("resize",z),window.removeEventListener("message",j),e.events.off("page.changeTitle",y),e.events.off("file.sort",y),_.value&&URL.revokeObjectURL(_.value)});function z(){q.value=N.value.getBoundingClientRect()}function y(i){w==null||w(B.value,i)}async function G(i,{persistScrollPosition:u=!0}={}){var H,J;if(C.value)return;C.value=!0;const g=e.view.path.startsWith("pages/")?e.view.path.slice(6).replaceAll("+","/"):void 0;let m=0;E.value&&(m=E.value.contentWindow.scrollY,(J=(H=K.value)==null?void 0:H.contentWindow)==null||J.scrollTo(0,m)),S.value=!0;try{const{html:O}=await n.post("__live-preview__/render",{id:g,content:i,interactable:d.value}),Q=_.value,Ee=new Blob([O],{type:"text/html"});_.value=URL.createObjectURL(Ee),await A(),await new Promise(xe=>{E.value.addEventListener("load",()=>{m&&u&&E.value.contentWindow.scrollTo(0,m),xe()},{once:!0})}),S.value=!1,P.value=!1,F.value=_.value,Q&&URL.revokeObjectURL(Q)}catch(O){console.error(O),P.value=!0,S.value=!1}finally{C.value=!1}}async function j({data:i}){if(i.type==="save"){e.events.emit(`${e.context}.save`);return}if(i.type==="link"){const u=new URL(i.href);if(u.origin!==window.location.origin){window.open(i.href,"_blank");return}if(["assets","media"].some(m=>u.pathname.startsWith(`/${m}/`)))return;let g=c(u).slice(1);g?(g=g.replace(/\/[^/]+?:.+$/,""),g=de("pages",g.replaceAll("/","+"))):g="site";try{e.isLoading=!0;const m=await e.get(M(g));e.set(m),e.isLoading=!1}catch(m){console.error(m)}}}function V(i){return!i||typeof i=="string"?i:i[e.translation.code]??Object.values(i)[0]}async function Re(){const{isRegistered:i}=await v();i&&(p.value="active")}return{__sfc:!0,propsDefinition:D,props:r,panel:e,api:n,store:a,getNonLocalizedPath:c,openLicenseModal:v,assertActivationIntegrity:k,label:s,updateInterval:f,interactable:d,aspectRatio:L,logLevel:R,help:x,license:p,isRendering:C,showTransitionIframe:S,hasError:P,blobUrl:_,transitionBlobUrl:F,containerRect:q,container:N,iframe:E,transitionIframe:K,licenseButtonGroup:W,throttledRenderPreview:w,unsavedContent:B,updateSectionHeight:z,renderUnsavedContent:y,renderPreview:G,handleMessage:j,t:V,handleRegistration:Re}}});var be=function(){var r=this,e=r._self._c,n=r._self._setupProxy;return e("k-section",{attrs:{label:n.label}},[e("k-button-group",{attrs:{slot:"options"},slot:"options"},[n.license!=="active"?e("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[e("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:"https://kirby.tools/live-preview#pricing",target:"_blank",text:n.panel.t("johannschopplich.preview.license.buy")}}),e("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:n.panel.t("johannschopplich.preview.license.activate")},on:{click:function(a){return n.handleRegistration()}}})],1):r._e(),e("k-button",{attrs:{variant:"filled",size:"xs",icon:"live-preview-restart"},on:{click:function(a){return n.renderUnsavedContent()}}})],1),e("div",{ref:"container",staticClass:"klp-grid klp-min-h-[55dvh] klp-rounded-[var(--input-rounded)]",class:[n.isRendering&&"klp-pointer-events-none",n.transitionBlobUrl&&!n.hasError&&"k-shadow-md",(!n.transitionBlobUrl||n.hasError)&&"klp-border klp-border-dashed klp-border-[var(--color-gray-400)]"],style:{aspectRatio:n.aspectRatio,height:n.aspectRatio?"auto":`calc(100dvh - ${n.containerRect.top??0}px - var(--spacing-3))`,maxWidth:"100%"},attrs:{"data-theme":"passive"}},[n.transitionBlobUrl?e("iframe",{ref:"transitionIframe",staticClass:"klp-h-full klp-w-full klp-rounded-[var(--input-rounded)] klp-bg-white",class:[n.hasError&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1 / 1 / 1"},attrs:{src:n.transitionBlobUrl}}):r._e(),n.blobUrl?e("iframe",{ref:"iframe",staticClass:"klp-h-full klp-w-full klp-rounded-[var(--input-rounded)] klp-bg-white",class:[(n.showTransitionIframe||n.hasError)&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1 / 1 / 1"},attrs:{src:n.blobUrl}}):r._e(),n.hasError?e("div",{staticClass:"klp-flex klp-items-center klp-justify-center",style:{gridArea:"1 / 1 / 1 / 1"}},[e("k-button",{attrs:{variant:"filled",theme:"notice",icon:"alert",text:n.panel.t("johannschopplich.preview.error.render")},on:{click:function(a){return n.renderUnsavedContent({persistScrollPosition:!1})}}})],1):r._e()]),n.help?e("k-text",{staticClass:"k-help klp-mt-2",attrs:{html:n.help}}):r._e()],1)},ke=[],Le=we(ye,be,ke,!1,null,"5cb20740");const _e=Le.exports;window.panel.plugin("johannschopplich/live-preview",{sections:{preview:_e},icons:{"live-preview-restart":'<path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772z" />'}})})();
