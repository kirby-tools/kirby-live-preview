(function(){"use strict";const r=window.Vue;function m(){return window.panel}function D(){return m().api}const $=()=>window.panel.plugins.viewButtons!==void 0;function re(){return $()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):m().app.$store}function ie(){const t=m(),n=re(),o=$(),e=h(o?()=>t.view.props.content:()=>n.getters["content/values"]()),a=h(o?()=>t.content.changes():()=>n.getters["content/changes"]()),i=h(o?()=>Object.keys(a.value).length>0:()=>n.getters["content/hasChanges"]()),l=o?t.content:new Proxy({},{get(){return()=>{}}});return{content:l,currentContent:e,contentChanges:a,hasChanges:i,update:async(u,g=!0)=>{if(!o&&u)for(const[C,A]of Object.entries(u))n.dispatch("content/update",[C,A]);const S=l.merge(u);g&&await l.save(S)}}}function ae(){const t=m();function n(o){return!o||typeof o=="string"?o:o[t.translation.code]??Object.values(o)[0]}return{t:n}}function se(){const t=D();return{load:({parent:o,name:e})=>t.get(`${o}/sections/${e}`)}}const h=r.computed;r.customRef,r.defineAsyncComponent,r.defineComponent,r.effectScope,r.getCurrentInstance,r.getCurrentScope,r.h,r.inject,r.isProxy,r.isReactive,r.isReadonly,r.isRef,r.isShallow,r.markRaw;const K=r.nextTick;r.onActivated,r.onBeforeMount;const V=r.onBeforeUnmount;r.onBeforeUpdate,r.onDeactivated,r.onErrorCaptured;const le=r.onMounted;r.onRenderTracked,r.onRenderTriggered,r.onScopeDispose,r.onServerPrefetch,r.onUnmounted,r.onUpdated,r.provide,r.proxyRefs,r.reactive,r.readonly;const s=r.ref;r.shallowReactive,r.shallowReadonly,r.shallowRef,r.toRaw,r.toRef,r.toRefs,r.triggerRef;const H=r.unref;r.useAttrs,r.useCssModule,r.useCssVars,r.useListeners,r.useSlots;const G=r.watch;r.watchEffect,r.watchPostEffect,r.watchSyncEffect;const q={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Find your order number</a> on Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible":"License key invalid for this plugin version","modal.error.upgradeable":"License key invalid for this plugin version. Upgrade now on https://hub.kirby.tools.","modal.error.activated":"License key already activated",activate:"Activate",activated:"Plugin activated",buy:"Buy a license",upgrade:"Upgrade"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Finde deine Bestellnummer</a> bei Lemon Squeezy oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.upgradeable":"Lizenzschlüssel ungültig für diese Plugin-Version. Aktualisiere jetzt auf https://hub.kirby.tools.","modal.error.activated":"Lizenzschlüssel bereits aktiviert",activate:"Aktivieren",activated:"Plugin aktiviert",buy:"Lizenz kaufen",upgrade:"Upgrade"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Trouvez votre numéro de commande</a> sur Lemon Squeezy ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible":"Clé de licence invalide pour cette version du plugin","modal.error.upgradeable":"Clé de licence invalide pour cette version du plugin. Mettez à niveau maintenant sur https://hub.kirby.tools.","modal.error.activated":"Clé de licence déjà activée",activate:"Activer",activated:"Plugin activé",buy:"Acheter une licence",upgrade:"Upgrade"},nl:{"modal.info":"Bedankt voor het kopen van {label}! Voer je e-mailadres en bestelnummer in om je licentie te activeren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Vind je bestelnummer</a> op Lemon Squeezy of <a href="mailto:hello@kirby.tools">neem contact met ons op</a> als je het niet kunt vinden.',"modal.error.required.fields":"E-mailadres en bestelnummer zijn verplicht","modal.error.invalid.unauthorized":"E-mailadres of bestelnummer is onjuist","modal.error.invalid.licenseKey":"Licentiesleutel ongeldig voor dit plug-in","modal.error.incompatible":"Licentiesleutel ongeldig voor deze plug-inversie","modal.error.upgradeable":"Licentiesleutel ongeldig voor deze plug-inversie. Upgrade nu op https://hub.kirby.tools.","modal.error.activated":"Licentiesleutel al geactiveerd",activate:"Activeren",activated:"Plugin geactiveerd",buy:"Koop een licentie",upgrade:"Upgrade"}},ce=["localhost","127.0.0.1","[::1]"],ue=["local","test","ddev.site"];function b(t="",n){var a;const o=window.panel.translation.code,e=((a=q==null?void 0:q[o])==null?void 0:a[t])??t;return n?de(e,n):e}function de(t,n,o){return t.replace(/\{(\w+)\}/g,(e,a)=>n[a]||a)}function pe(){const{hostname:t}=window.location,n=ce.includes(t),o=ue.some(e=>t.endsWith(`.${e}`));return n||o}const W={Unauthorized:"modal.error.invalid.unauthorized","License key not valid for this plugin":"modal.error.invalid.licenseKey","License key not valid for this plugin version":"modal.error.incompatible","License key not valid for this plugin version, please upgrade your license":"modal.error.upgradeable","License key already activated":"modal.error.activated"};function fe(t){const n=m();return{isLocalhost:pe(),assertActivationIntegrity:async({component:i,licenseStatus:l})=>{if(H(l)==="active")return;const d=H(i);if(!(d!=null&&d.$el)||window.getComputedStyle(d.$el).display==="none"||window.getComputedStyle(d.$el).visibility==="hidden"||window.getComputedStyle(d.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let i=!1;const{label:l}=t,d={info:{type:"info",text:b("modal.info",{label:l})},email:{label:n.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:b("modal.fields.orderId.help",{label:l})}};return new Promise(u=>{n.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:b("activate",{label:l})},fields:d},on:{close:()=>{u({isLicenseActive:i})},submit:async g=>{i=await ve(g,t),i&&(n.dialog.close(),n.notification.success(b("activated")))}}})})}}}async function ve(t,n){const o=m(),{email:e,orderId:a}=t;if(!e||!a)return o.notification.error(b("modal.error.required.fields")),!1;try{const i=await o.api.post(`${n.apiNamespace}/activate`,{email:e,orderId:Number(a)});if((i==null?void 0:i.status)!=="ok")throw new Error("Failed to activate license key");return!0}catch(i){const l=i.message;return o.notification.error(W[l]?b(W[l]):l),!1}}const me=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(t){const n=t,{openLicenseModal:o,assertActivationIntegrity:e}=fe({label:n.label,apiNamespace:n.apiNamespace}),a=s(n.licenseStatus),i=s();le(()=>{e({component:i,licenseStatus:n.licenseStatus})});async function l(){const{isLicenseActive:d}=await o();d&&window.location.reload()}return{__sfc:!0,props:n,openLicenseModal:o,assertActivationIntegrity:e,currentLicenseStatus:a,licenseButtonGroup:i,handleRegistration:l,t:b}}});function J(t,n,o,e,a,i,l,d){var u=typeof t=="function"?t.options:t;return n&&(u.render=n,u.staticRenderFns=o,u._compiled=!0),i&&(u._scopeId="data-v-"+i),{exports:t,options:u}}var ge=function(){var n=this,o=n._self._c,e=n._self._setupProxy;return e.currentLicenseStatus!=="active"?o("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[o("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":n.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),o("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(a){return e.handleRegistration()}}})],1):n._e()},he=[],be=J(me,ge,he,!1,null,null);const ye=be.exports,we={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number};function ke(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function _e(t,n){if(typeof t!="function")throw new TypeError(`Expected the first argument to be a \`function\`, got \`${typeof t}\`.`);let o,e=0;return function(...i){clearTimeout(o);const l=Date.now(),d=l-e,u=n-d;u<=0?(e=l,t.apply(this,i)):o=setTimeout(()=>{e=Date.now(),t.apply(this,i)},u)}}var Le=_e;const xe=ke(Le),Se=/^\.?\//;function Ce(t="",n){return t.endsWith("/")?t:t+"/"}function Ee(t=""){return t.startsWith("/")}function Q(t=""){return Ee(t)?t:"/"+t}function ze(t){return t&&t!=="/"}function Re(t,...n){let o=t||"";for(const e of n.filter(a=>ze(a)))if(o){const a=e.replace(Se,"");o=Ce(o)+a}else o=e;return o}function Ue(){const n=m().languages.map(e=>e.code);return{locales:n,getNonLocalizedPath:e=>{const i=(e instanceof URL?e:new URL(e)).pathname.split("/").filter(Boolean);return n.includes(i[0])&&i.shift(),Q(i.join("/"))}}}const Ae="__live-preview__/context",Ie=["error","warn","info","debug"];let U,x;function Pe(){return U||x||(x=window.panel.api.get(Ae).then(t=>(U=t,x=void 0,U)),x)}const X={...we},Be=Object.assign({inheritAttrs:!1},{__name:"LivePreview",props:X,setup(t){const n=t,o=$(),e=m(),a=D(),{t:i}=ae(),{getNonLocalizedPath:l}=Ue(),d=s(),u=s(),g=s(),S=s(),C=s(),A=s(),I=s(),Y=s(),P=s(!1),B=s(!1),F=s(!1),k=s(),Z=s(),ee=s(),qe=s(),E=s(),te=s();let v,j;const O=new AbortController,{contentChanges:z}=ie();G(z,p=>{v&&g.value!==!1&&I.value==="interval"&&JSON.stringify(p)!==j&&v(p)}),G(()=>e.language.code,()=>{y()});const M=s(!0),T=s(0),N=s(0),Fe=h(()=>`calc(100dvh - ${M.value?`calc(${T.value}px + var(--spacing-8))`:"-2.75rem"} - ${N.value}px - 6.5rem`);(async()=>{const{load:p}=se(),[w,c]=await Promise.all([Pe(),p({parent:n.parent,name:n.name})]);d.value=i(c.label)||e.t("johannschopplich.preview.label"),u.value=c.pageId,g.value=c.updateInterval,S.value=c.interactable,C.value=c.aspectRatio||void 0,A.value=Ie.indexOf(c.logLevel),I.value=c.updateStrategy,Y.value=c.help,ee.value=w.licenseStatus,v=xe(ne,g.value||250),y(),await K();const f=document.querySelector(".k-topbar"),R=document.querySelector(".k-header");if(!C.value&&f&&R){T.value=f.offsetHeight,N.value=R.offsetHeight;const _=new IntersectionObserver(([L])=>{M.value=L.isIntersecting,L.isIntersecting&&(T.value=L.target.offsetHeight)},{threshold:[0],rootMargin:"32px 0px 0px 0px"});_.observe(f),V(_.disconnect)}window.addEventListener("message",oe,{signal:O.signal}),e.events.on("page.changeTitle",y),e.events.on("file.sort",y),I.value==="blur"&&document.body.addEventListener("blur",()=>{JSON.stringify(z.value)!==j&&(v==null||v(z.value))},{capture:!0,signal:O.signal})})(),V(()=>{O.abort(),e.events.off("page.changeTitle",y),e.events.off("file.sort",y),k.value&&URL.revokeObjectURL(k.value)});function y(p){v==null||v(z.value,p)}async function ne(p,{persistScrollPosition:w=!0}={}){var f,R;if(P.value)return;P.value=!0;let c=0;E.value&&(c=E.value.contentWindow.scrollY,(R=(f=te.value)==null?void 0:f.contentWindow)==null||R.scrollTo(0,c)),B.value=!0;try{const{html:_}=await a.post("__live-preview__/render",{id:u.value,content:p,interactable:S.value}),L=k.value,Me=new Blob([_],{type:"text/html"});k.value=URL.createObjectURL(Me),await K(),await new Promise(Ne=>{E.value.addEventListener("load",()=>{c&&w&&E.value.contentWindow.scrollTo(0,c),Ne()},{once:!0})}),B.value=!1,F.value=!1,Z.value=k.value,j=JSON.stringify(p),L&&URL.revokeObjectURL(L)}catch(_){console.error(_),F.value=!0,B.value=!1}finally{P.value=!1}}async function oe({data:p}){if(p.type==="save"){e.events.emit(`${e.context}.save`);return}if(p.type==="link"){const w=new URL(p.href);if(w.origin!==window.location.origin){window.open(p.href,"_blank");return}if(["assets","media"].some(f=>w.pathname.startsWith(`/${f}/`)))return;let c=l(w).slice(1);c?(c=c.replace(/\/[^/]+?:.+$/,""),c=Re("pages",c.replaceAll("/","+"))):c="site";try{e.isLoading=!0;const f=await e.get(Q(c));e.set(f),e.isLoading=!1}catch(f){console.error(f)}}}return{__sfc:!0,propsDefinition:X,props:n,_isKirby5:o,panel:e,api:a,t:i,getNonLocalizedPath:l,label:d,pageId:u,updateInterval:g,interactable:S,aspectRatio:C,logLevel:A,updateStrategy:I,help:Y,isRendering:P,showTransitionIframe:B,hasError:F,blobUrl:k,transitionBlobUrl:Z,licenseStatus:ee,container:qe,iframe:E,transitionIframe:te,throttledRenderPreview:v,lastRenderedContent:j,eventAbortController:O,contentChanges:z,isTopbarVisible:M,topbarHeight:T,headerHeight:N,containerHeight:Fe,renderUnsavedContent:y,renderPreview:ne,handleMessage:oe,LicensingButtonGroup:ye}}});var je=function(){var n=this,o=n._self._c,e=n._self._setupProxy;return o("k-section",{attrs:{label:e.label}},[o("div",{staticClass:"klp-flex klp-items-center klp-gap-2",attrs:{slot:"options"},slot:"options"},[e.licenseStatus!==void 0?o(e.LicensingButtonGroup,{attrs:{label:"Kirby Live Preview","api-namespace":"__live-preview__","license-status":e.licenseStatus,"pricing-url":"https://kirby.tools/live-preview#pricing"}}):n._e(),o("k-button",{attrs:{variant:"filled",size:"xs",icon:"live-preview-restart"},on:{click:function(a){return e.renderUnsavedContent()}}})],1),o("div",{ref:"container",staticClass:"klp-grid klp-min-h-[55dvh] klp-rounded-[var(--input-rounded)]",class:[e.isRendering&&"klp-pointer-events-none",e.transitionBlobUrl&&!e.hasError&&"k-shadow-md",(!e.transitionBlobUrl||e.hasError)&&"klp-border klp-border-dashed klp-border-[var(--preview-color-border)]"],style:{"--preview-color-border":e._isKirby5?"light-dark(var(--color-gray-400),var(--color-border))":"var(--color-gray-400)",aspectRatio:e.aspectRatio,height:e.aspectRatio?"auto":e.containerHeight,maxWidth:"100%"},attrs:{"data-theme":"passive"}},[e.transitionBlobUrl?o("iframe",{ref:"transitionIframe",staticClass:"klp-h-full klp-w-full klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[e.hasError&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1 / 1 / 1"},attrs:{src:e.transitionBlobUrl}}):n._e(),e.blobUrl?o("iframe",{ref:"iframe",staticClass:"klp-h-full klp-w-full klp-rounded-[var(--input-rounded)] klp-bg-[var(--input-color-back)]",class:[(e.showTransitionIframe||e.hasError)&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1 / 1 / 1"},attrs:{src:e.blobUrl}}):n._e(),e.hasError?o("div",{staticClass:"klp-flex klp-items-center klp-justify-center",style:{gridArea:"1 / 1 / 1 / 1"}},[o("k-button",{attrs:{variant:"filled",theme:"notice",icon:"alert",text:e.panel.t("johannschopplich.preview.error.render")},on:{click:function(a){return e.renderUnsavedContent({persistScrollPosition:!1})}}})],1):n._e()]),e.help?o("k-text",{staticClass:"k-help klp-mt-2",attrs:{html:e.help}}):n._e()],1)},Oe=[],Te=J(Be,je,Oe,!1,null,"8ad2d93f");const $e=Te.exports;window.panel.plugin("johannschopplich/live-preview",{sections:{preview:$e},icons:{"live-preview-restart":'<path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772z" />'}})})();
