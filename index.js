(function(){"use strict";const t=window.Vue;function _(){return window.panel}function U(){return _().api}function G(){const o=U();return{load:({parent:e,name:n})=>o.get(`${e}/sections/${n}`)}}function J(){var r;return((r=t.getCurrentInstance())==null?void 0:r.proxy).$store}const Q=t.computed;t.customRef,t.defineAsyncComponent,t.defineComponent,t.effectScope,t.getCurrentInstance,t.getCurrentScope,t.h,t.inject,t.isProxy,t.isReactive,t.isReadonly,t.isRef,t.isShallow,t.markRaw;const O=t.nextTick;t.onActivated,t.onBeforeMount;const Y=t.onBeforeUnmount;t.onBeforeUpdate,t.onDeactivated,t.onErrorCaptured,t.onMounted,t.onRenderTracked,t.onRenderTriggered,t.onScopeDispose,t.onServerPrefetch,t.onUnmounted,t.onUpdated,t.provide,t.proxyRefs,t.reactive,t.readonly;const c=t.ref;t.shallowReactive,t.shallowReadonly,t.shallowRef,t.toRaw,t.toRef,t.toRefs,t.triggerRef,t.unref,t.useAttrs,t.useCssModule,t.useCssVars,t.useListeners,t.useSlots;const j=t.watch;t.watchEffect,t.watchPostEffect,t.watchSyncEffect;const X={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number};function Z(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function ee(o,r){let e,n=0;return function(...l){clearTimeout(e);const p=Date.now(),u=p-n,s=r-u;s<=0?(n=p,o.apply(this,l)):e=setTimeout(()=>{n=Date.now(),o.apply(this,l)},s)}}var te=ee;const ne=Z(te),oe=/^\.?\//;function re(o="",r){return o.endsWith("/")?o:o+"/"}function ae(o=""){return o.startsWith("/")}function T(o=""){return ae(o)?o:"/"+o}function ie(o){return o&&o!=="/"}function se(o,...r){let e=o||"";for(const n of r.filter(i=>ie(i)))if(e){const i=n.replace(oe,"");e=re(e)+i}else e=n;return e}const z={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Get your order number</a> from Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.licenseKey":"License key invalid for this plugin",activate:"Activate",activated:"Plugin activated"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'Rufe die <a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Bestellnummer von Lemon Squeezy ab</a> oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin",activate:"Aktivieren",activated:"Plugin aktiviert"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'Obtenez votre numéro de commande sur <a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Lemon Squeezy</a> ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin",activate:"Activer",activated:"Plugin activé"}};function y(o,r,e){var p;const i=_().translation.code,l=((p=z==null?void 0:z[i])==null?void 0:p[o])??e;if(l)return r?le(l,r):l}function le(o,r,e){return o.replace(/\{(\w+)\}/g,(n,i)=>r[i]||i)}const ce=["localhost","127.0.0.1","[::1]"],de=["local","test","ddev.site"];function ue({label:o,apiNamespace:r}){const e=_(),n=U(),i=pe(),l=async(u,s)=>{if(!u||!s)throw new Error("Email and order ID are required");const v=await n.post(`${r}/register`,{email:u,orderId:s});if((v==null?void 0:v.status)!=="ok")throw new Error("Registration failed");return!0};return{isLocalhost:i,openLicenseModal:()=>{let u=!1;return new Promise(s=>{e.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:y("activate",{label:o})},fields:{info:{type:"info",text:y("modal.info",{label:o})},email:{label:e.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:y("modal.fields.orderId.help",{label:o})}}},on:{close:()=>{s({isRegistered:u})},submit:async v=>{const{email:k,orderId:L}=v;if(!k||!L){e.notification.error(y("modal.error.required.fields"));return}try{await l(k,Number(L))}catch(x){let m=x.message;m==="License key not valid for this plugin"&&(m=y("modal.error.invalid.licenseKey")),e.notification.error(m);return}u=!0,e.dialog.close(),e.notification.success(y("activated"),{label:o})}}})})}}}function pe(){const{hostname:o}=window.location,r=ce.includes(o),e=de.some(n=>o.endsWith(`.${n}`));return r||e}function fe(){const r=_().languages.map(n=>n.code);return{locales:r,getNonLocalizedPath:n=>{const l=(n instanceof URL?n:new URL(n)).pathname.split("/").filter(Boolean);return r.includes(l[0])&&l.shift(),T(l.join("/"))}}}const ve=["error","warn","info","debug"];function he(o,r,e,n,i,l,p,u){var s=typeof o=="function"?o.options:o;return r&&(s.render=r,s.staticRenderFns=e,s._compiled=!0),s._scopeId="data-v-"+l,{exports:o,options:s}}const M={...X},me=Object.assign({inheritAttrs:!1},{__name:"Preview",props:M,setup(o){const r=o,e=_(),n=U(),i=J(),{getNonLocalizedPath:l}=fe(),{openLicenseModal:p}=ue({label:"Kirby Live Preview",apiNamespace:"__live-preview__"}),u=c(),s=c(),v=c(),k=c(),L=c(),x=c(),m=c(),C=c(!1),S=c(!1),A=c(!1),b=c(),D=c(),q=c({}),$=c(),R=c(),N=c();let g;const I=Q(()=>i.getters["content/changes"]());j(I,(a,d)=>{g&&s.value!==!1&&JSON.stringify(a)!==JSON.stringify(d)&&g(a)},{deep:!0}),j(()=>e.language.code,()=>{w()}),(async()=>{const{load:a}=G(),d=await a({parent:r.parent,name:r.name});u.value=W(d.label)||e.t("johannschopplich.preview.label"),s.value=d.updateInterval,v.value=d.interactable,k.value=d.aspectRatio||void 0,L.value=ve.indexOf(d.logLevel),x.value=d.help,m.value=d.license,g=ne(F,s.value||250),w(),await O(),k.value||(E(),window.addEventListener("resize",E)),window.addEventListener("message",P),e.events.on("page.changeTitle",w),e.events.on("file.sort",w)})(),Y(()=>{window.removeEventListener("resize",E),window.removeEventListener("message",P),e.events.off("page.changeTitle",w),e.events.off("file.sort",w),b.value&&URL.revokeObjectURL(b.value)});function E(){q.value=$.value.getBoundingClientRect()}function w(a){g==null||g(I.value,a)}async function F(a,{persistScrollPosition:d=!0}={}){var K,H;if(C.value)return;C.value=!0;const h=e.view.path.startsWith("pages/")?e.view.path.slice(6).replaceAll("+","/"):void 0;let f=0;R.value&&(f=R.value.contentWindow.scrollY,(H=(K=N.value)==null?void 0:K.contentWindow)==null||H.scrollTo(0,f)),S.value=!0;try{const{html:B}=await n.post("__live-preview__/render",{id:h,content:a,interactable:v.value}),V=b.value,_e=new Blob([B],{type:"text/html"});b.value=URL.createObjectURL(_e),await O(),await new Promise(Le=>{R.value.addEventListener("load",()=>{f&&d&&R.value.contentWindow.scrollTo(0,f),Le()},{once:!0})}),S.value=!1,A.value=!1,D.value=b.value,V&&URL.revokeObjectURL(V)}catch(B){console.error(B),A.value=!0,S.value=!1}finally{C.value=!1}}async function P({data:a}){if(a.type==="save"){e.events.emit(`${e.context}.save`);return}if(a.type==="link"){const d=new URL(a.href);if(d.origin!==window.location.origin){window.open(a.href,"_blank");return}if(["assets","media"].some(f=>d.pathname.startsWith(`/${f}/`)))return;let h=l(d).slice(1);h?(h=h.replace(/\/[^/]+?:.+$/,""),h=se("pages",h.replaceAll("/","+"))):h="site";try{e.isLoading=!0;const f=await e.get(T(h));e.set(f),e.isLoading=!1}catch(f){console.error(f)}}}function W(a){return!a||typeof a=="string"?a:a[e.translation.code]??Object.values(a)[0]}async function be(){const{isRegistered:a}=await p();a&&(m.value=!0)}return{__sfc:!0,propsDefinition:M,props:r,panel:e,api:n,store:i,getNonLocalizedPath:l,openLicenseModal:p,label:u,updateInterval:s,interactable:v,aspectRatio:k,logLevel:L,help:x,license:m,isRendering:C,showTransitionIframe:S,hasError:A,blobUrl:b,transitionBlobUrl:D,containerRect:q,container:$,iframe:R,transitionIframe:N,throttledRenderPreview:g,unsavedContent:I,updateSectionHeight:E,renderUnsavedContent:w,renderPreview:F,handleMessage:P,t:W,handleRegistration:be}}});var ge=function(){var r=this,e=r._self._c,n=r._self._setupProxy;return e("k-section",{attrs:{label:n.label}},[e("k-button-group",{attrs:{slot:"options"},slot:"options"},[n.license===!1?e("k-button-group",{attrs:{layout:"collapsed"}},[e("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:"https://kirby.tools/live-preview#pricing",target:"_blank",text:n.panel.t("johannschopplich.preview.license.buy")}}),e("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:n.panel.t("johannschopplich.preview.license.activate")},on:{click:function(i){return n.handleRegistration()}}})],1):r._e(),e("k-button",{attrs:{variant:"filled",size:"xs",icon:"live-preview-restart"},on:{click:function(i){return n.renderUnsavedContent()}}})],1),e("div",{ref:"container",staticClass:"klp-grid klp-min-h-[55dvh] klp-rounded-[var(--input-rounded)]",class:[n.isRendering&&"klp-pointer-events-none",n.transitionBlobUrl&&!n.hasError&&"k-shadow-md",(!n.transitionBlobUrl||n.hasError)&&"klp-border klp-border-dashed klp-border-[var(--color-gray-400)]"],style:{aspectRatio:n.aspectRatio,height:n.aspectRatio?"auto":`calc(100dvh - ${n.containerRect.top??0}px - var(--spacing-3))`,maxWidth:"100%"},attrs:{"data-theme":"passive"}},[n.transitionBlobUrl?e("iframe",{ref:"transitionIframe",staticClass:"klp-h-full klp-w-full klp-rounded-[var(--input-rounded)] klp-bg-white",class:[n.hasError&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1 / 1 / 1"},attrs:{src:n.transitionBlobUrl}}):r._e(),n.blobUrl?e("iframe",{ref:"iframe",staticClass:"klp-h-full klp-w-full klp-rounded-[var(--input-rounded)] klp-bg-white",class:[(n.showTransitionIframe||n.hasError)&&"klp-pointer-events-none klp-opacity-0"],style:{gridArea:"1 / 1 / 1 / 1"},attrs:{src:n.blobUrl}}):r._e(),n.hasError?e("div",{staticClass:"klp-flex klp-items-center klp-justify-center",style:{gridArea:"1 / 1 / 1 / 1"}},[e("k-button",{attrs:{variant:"filled",theme:"notice",icon:"alert",text:n.panel.t("johannschopplich.preview.error.render")},on:{click:function(i){return n.renderUnsavedContent({persistScrollPosition:!1})}}})],1):r._e()]),n.help?e("k-text",{staticClass:"k-help klp-mt-2",attrs:{html:n.help}}):r._e()],1)},we=[],ye=he(me,ge,we,!1,null,"751f9901");const ke=ye.exports;window.panel.plugin("johannschopplich/live-preview",{sections:{preview:ke},icons:{"live-preview-restart":'<path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772z" />'}})})();
